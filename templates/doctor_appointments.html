<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointments - NeuraX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='neurax-theme.css') }}">
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 neurax-sidebar text-white shadow-xl z-50 overflow-y-auto">
        <div class="p-6 border-b border-indigo-400 border-opacity-30">
            <div class="mb-4">
                <h2 class="neurax-logo text-2xl font-extrabold text-white">Neura<span
                        class="neurax-logo-accent">X</span></h2>
                <p class="text-xs text-indigo-200 text-center">Healthcare Intelligence</p>
            </div>
        </div>
        <nav class="mt-4">
            <a href="/doctor/dashboard" class="neurax-sidebar-item flex items-center px-6 py-3">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
                Dashboard
            </a>
            <a href="/doctor/appointments" class="neurax-sidebar-item active flex items-center px-6 py-3">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                    </path>
                </svg>
                Appointments
            </a>
            <a href="/doctor/chat" class="neurax-sidebar-item flex items-center px-6 py-3">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                    </path>
                </svg>
                Messages
            </a>
            <a href="/profile" class="neurax-sidebar-item flex items-center px-6 py-3">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                My Profile
            </a>
            <a href="/logout"
                class="neurax-sidebar-item flex items-center px-6 py-3 text-red-200 hover:bg-red-600 hover:bg-opacity-30 transition absolute bottom-0 w-full border-t border-indigo-400 border-opacity-30">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
                Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">My Appointments</h1>

            <!-- Appointments List -->
            <div id="appointmentsList" class="bg-white rounded-lg shadow-md p-6">
                <div class="text-center text-gray-500 py-8">
                    <p>Loading appointments...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            loadAppointments();
        });

        async function loadAppointments() {
            try {
                const response = await fetch('/api/appointments');
                const data = await response.json();

                let html = '';
                if (data.appointments && data.appointments.length > 0) {
                    // Separate pending and other appointments
                    const pendingAppointments = data.appointments.filter(apt => apt.status === 'pending');
                    const otherAppointments = data.appointments.filter(apt => apt.status !== 'pending');

                    // Pending Requests Section
                    if (pendingAppointments.length > 0) {
                        html += `
                            <div class="mb-8 bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6">
                                <h2 class="text-xl font-bold text-yellow-800 mb-4 flex items-center">
                                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Pending Appointment Requests (${pendingAppointments.length})
                                </h2>
                                <div class="space-y-4">
                        `;

                        pendingAppointments.forEach(apt => {
                            html += `
                                <div class="bg-white rounded-lg p-4 shadow-md border-l-4 border-yellow-500">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold text-lg">${apt.patient_name || 'Unknown Patient'}</p>
                                            <p class="text-gray-600">${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time}</p>
                                            <p class="text-sm text-gray-500">Type: ${apt.appointment_type || 'consultation'}</p>
                                            ${apt.reason ? `<p class="text-sm text-gray-500 mt-1">Reason: ${apt.reason}</p>` : ''}
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="respondToAppointment(${apt.id}, 'accept')" 
                                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                                                ✓ Accept
                                            </button>
                                            <button onclick="respondToAppointment(${apt.id}, 'reject')" 
                                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">
                                                ✕ Reject
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div></div>';
                    }

                    // Other Appointments Table
                    if (otherAppointments.length > 0) {
                        html += '<h2 class="text-xl font-bold text-gray-800 mb-4">Scheduled Appointments</h2>';
                        html += '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
                        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>';
                        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>';
                        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient</th>';
                        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>';
                        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reason</th>';
                        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>';
                        html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>';
                        html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

                        otherAppointments.forEach(apt => {
                            const statusColors = {
                                'scheduled': 'bg-blue-100 text-blue-800',
                                'confirmed': 'bg-green-100 text-green-800',
                                'completed': 'bg-gray-100 text-gray-800',
                                'cancelled': 'bg-red-100 text-red-800',
                                'rejected': 'bg-red-100 text-red-800'
                            };
                            html += `<tr>
                                <td class="px-6 py-4 whitespace-nowrap">${new Date(apt.appointment_date).toLocaleDateString()}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${apt.appointment_time}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div>
                                        <p class="font-semibold">${apt.patient_name || 'N/A'}</p>
                                        ${apt.patient_email ? `<p class="text-xs text-gray-500">${apt.patient_email}</p>` : ''}
                                        ${apt.patient_phone ? `<p class="text-xs text-gray-500">${apt.patient_phone}</p>` : ''}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">${apt.appointment_type || 'consultation'}</td>
                                <td class="px-6 py-4">${apt.reason || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded ${statusColors[apt.status] || 'bg-gray-100'}">${apt.status || 'scheduled'}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${apt.status !== 'completed' && apt.status !== 'cancelled' && apt.status !== 'rejected' ?
                                    `<button onclick="updateStatus(${apt.id}, 'completed')" class="text-green-600 hover:text-green-900 mr-2">Complete</button>
                                         <button onclick="updateStatus(${apt.id}, 'cancelled')" class="text-red-600 hover:text-red-900">Cancel</button>` :
                                    '<span class="text-gray-400">No actions</span>'}
                                </td>
                            </tr>`;
                        });
                        html += '</tbody></table></div>';
                    }
                } else {
                    html = '<div class="text-center py-12"><p class="text-gray-500 text-lg">No appointments scheduled</p></div>';
                }
                document.getElementById('appointmentsList').innerHTML = html;
            } catch (error) {
                console.error('Appointments load error:', error);
                document.getElementById('appointmentsList').innerHTML = '<div class="text-center text-red-500 py-8">Error loading appointments. Please try again.</div>';
            }
        }

        async function respondToAppointment(appointmentId, action) {
            let rejectionReason = '';
            if (action === 'reject') {
                rejectionReason = prompt('Optional: Enter reason for rejection (or leave empty):') || '';
            }

            const confirmMessage = action === 'accept'
                ? 'Are you sure you want to accept this appointment request?'
                : 'Are you sure you want to reject this appointment request?';

            if (!confirm(confirmMessage)) return;

            try {
                const response = await fetch(`/api/appointments/${appointmentId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action, rejection_reason: rejectionReason })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`Appointment ${action === 'accept' ? 'accepted' : 'rejected'} successfully!`);
                    loadAppointments();
                } else {
                    alert(data.error || `Error ${action}ing appointment`);
                }
            } catch (error) {
                console.error('Respond to appointment error:', error);
                alert('Error: ' + error.message);
            }
        }

        async function updateStatus(appointmentId, status) {
            const action = status === 'completed' ? 'complete' : 'cancel';
            if (!confirm(`Are you sure you want to ${action} this appointment?`)) return;

            try {
                const response = await fetch(`/api/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });

                if (response.ok) {
                    alert(`Appointment ${status === 'completed' ? 'completed' : 'cancelled'} successfully`);
                    loadAppointments();
                } else {
                    const error = await response.json();
                    alert(error.error || `Error ${action === 'complete' ? 'completing' : 'cancelling'} appointment`);
                }
            } catch (error) {
                console.error('Update appointment error:', error);
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>

</html>