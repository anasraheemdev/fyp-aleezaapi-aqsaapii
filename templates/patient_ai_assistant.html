<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AI Health Assistant - NeuraX</title>
    <script src="https://cdn.tailwindcss.com?v=2.0"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=2.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * {
            font-family: 'Inter', sans-serif;
        }
        .patient-sidebar {
            background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%) !important;
        }
        .neurax-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%) !important;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
        }
        .patient-sidebar {
            background: linear-gradient(180deg, #4f46e5 0%, #6366f1 50%, #8b5cf6 100%) !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 patient-sidebar text-white shadow-2xl z-50 overflow-y-auto" style="background: linear-gradient(180deg, #4f46e5 0%, #6366f1 50%, #8b5cf6 100%);">
        <div class="p-6 border-b border-indigo-400 border-opacity-30">
            <div class="flex flex-col items-center mb-4">
                <div class="mb-4">
                    <h2 class="text-2xl font-extrabold text-white">Neura<span class="text-purple-300">X</span></h2>
                    <p class="text-xs text-indigo-200 text-center">Healthcare Intelligence</p>
                </div>
                <div id="profilePictureContainer" class="w-20 h-20 rounded-full bg-white bg-opacity-20 flex items-center justify-center mb-3 overflow-hidden shadow-lg border-2 border-white border-opacity-30">
                    <img id="profilePicture" src="" alt="Profile" class="w-full h-full object-cover hidden">
                    <svg id="profilePlaceholder" class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <h3 class="font-bold text-lg">{{ user.full_name or 'Patient' }}</h3>
                <p class="text-indigo-200 text-sm">Patient Portal</p>
            </div>
        </div>
        <nav class="mt-4">
            <a href="/patient/dashboard" class="flex items-center px-6 py-3 text-white hover:bg-indigo-600 hover:bg-opacity-30 transition">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                Dashboard
            </a>
            <a href="/patient/appointments" class="flex items-center px-6 py-3 text-white hover:bg-indigo-600 hover:bg-opacity-30 transition">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                My Appointments
            </a>
            <a href="/patient/chat" class="flex items-center px-6 py-3 text-white hover:bg-indigo-600 hover:bg-opacity-30 transition">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                Chat with Doctors
            </a>
            <a href="/patient/ai-assistant" class="flex items-center px-6 py-3 bg-indigo-600 bg-opacity-40 text-white border-l-4 border-purple-300 shadow-lg">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                AI Health Assistant
            </a>
            <a href="#" onclick="event.preventDefault(); showProfileModal();" class="flex items-center px-6 py-3 text-white hover:bg-indigo-600 hover:bg-opacity-30 transition">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                My Profile
            </a>
            <a href="/logout" class="flex items-center px-6 py-3 text-white hover:bg-red-500 hover:bg-opacity-30 transition absolute bottom-0 w-full border-t border-indigo-400 border-opacity-30">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="ml-64 min-h-screen">
        <!-- Header -->
        <div class="gradient-bg text-white py-8 mb-8 shadow-xl" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
            <div class="container mx-auto px-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-extrabold mb-2 flex items-center">
                            <svg class="w-10 h-10 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            AI Health Assistant
                        </h1>
                        <p class="text-indigo-100 text-lg">Powered by Clinical BERT - Your Intelligent Health Companion | <span class="font-semibold">NeuraX</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-8 max-w-6xl">
            <!-- Info Card -->
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl p-6 mb-6 shadow-md">
                <div class="flex items-start">
                    <svg class="w-8 h-8 text-indigo-600 mr-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold text-indigo-800 text-lg mb-2">About This Assistant</h3>
                        <p class="text-indigo-700 text-sm leading-relaxed">
                            This AI Health Assistant uses <strong>Clinical BERT</strong>, a specialized medical language model, to understand your health queries. 
                            It engages in a <strong>continuous conversation</strong> with you, asking follow-up questions based on your responses to better understand your health concerns. 
                            Each response is personalized using your medical history, current medications, and recent reports analyzed with Clinical BERT.
                        </p>
                        <p class="text-indigo-600 text-xs mt-2 italic">
                            ⚠️ Please note: This assistant provides general health information and should not replace professional medical advice. 
                            Always consult with your healthcare provider for serious concerns.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border-t-4 border-indigo-500">
                <div id="chatbotMessages" class="border-2 border-indigo-100 rounded-lg p-6 mb-6 min-h-96 max-h-[500px] overflow-y-auto bg-gradient-to-b from-gray-50 to-white space-y-4"></div>
                
            <!-- Chat Input Section -->
            <div id="chatInputSection">
                    <form id="chatbotForm" class="flex gap-3">
                        <input type="text" id="chatbotInput" placeholder="Type your response here..." class="flex-1 px-5 py-3 border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg" required>
                        <button type="submit" class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-md font-medium text-lg">
                            <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Send
                        </button>
                    </form>
                </div>
            </div>

            <!-- Features Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-purple-500">
                <h3 class="text-xl font-bold text-gray-800 mb-4">How It Works</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold mr-3">1</div>
                            <h4 class="font-semibold text-indigo-800">Start Conversation</h4>
                        </div>
                        <p class="text-sm text-indigo-700">The chatbot greets you and asks about your health concern to begin the conversation.</p>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold mr-3">2</div>
                            <h4 class="font-semibold text-purple-800">Continuous Q&A</h4>
                        </div>
                        <p class="text-sm text-purple-700">Based on your responses, the chatbot asks follow-up questions using Clinical BERT analysis to better understand your situation.</p>
                    </div>
                    <div class="p-4 bg-pink-50 rounded-lg border border-pink-200">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 bg-pink-600 rounded-full flex items-center justify-center text-white font-bold mr-3">3</div>
                            <h4 class="font-semibold text-pink-800">Personalized Guidance</h4>
                        </div>
                        <p class="text-sm text-pink-700">Receive context-aware responses and guidance based on your conversation history and medical records.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const patientId = {{ user.user_db_id or 1 }};

        // Load profile picture
        async function loadProfilePicture() {
            try {
                const response = await fetch('/api/user/profile');
                const data = await response.json();
                if (data.profile && data.profile.profile_picture) {
                    const img = document.getElementById('profilePicture');
                    const placeholder = document.getElementById('profilePlaceholder');
                    const path = data.profile.profile_picture.startsWith('profiles/') ? data.profile.profile_picture : `profiles/${data.profile.profile_picture}`;
                    img.src = `/static/${path}`;
                    img.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading profile picture:', error);
            }
        }

        // ==========================================
        // AI CHATBOT WITH CLINICAL BERT - CONTINUOUS Q&A
        // ==========================================
        
        let conversationHistory = [];  // Store conversation: [{role: 'user'|'assistant', content: '...'}]
        let conversationStarted = false;
        
        function resetChatbot() {
            conversationHistory = [];
            conversationStarted = false;
            document.getElementById('chatbotMessages').innerHTML = '';
            initializeChatbot();
        }
        
        async function initializeChatbot() {
            // Start with a greeting and first question
            const greeting = 'Hello! I\'m your AI Health Assistant powered by Clinical BERT. I\'m here to help you understand your health concerns better. To get started, could you tell me what health question or concern you have today?';
            addChatbotMessage(greeting, false);
            conversationHistory.push({role: 'assistant', content: greeting});
            conversationStarted = true;
            
            // Ensure chat input is visible
            document.getElementById('chatInputSection').classList.remove('hidden');
        }
        
        function addChatbotMessage(message, isUser = true) {
            const messagesDiv = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            messageDiv.innerHTML = `
                <div class="max-w-2xl px-5 py-4 rounded-xl shadow-md ${isUser ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white' : 'bg-gradient-to-r from-indigo-50 to-purple-50 text-gray-800 border-2 border-indigo-200'}">
                    <div class="flex items-start">
                        ${!isUser ? `
                            <svg class="w-6 h-6 mr-3 text-indigo-600 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        ` : ''}
                        <div class="flex-1">
                            <p class="text-sm font-semibold mb-1 ${isUser ? 'text-indigo-100' : 'text-indigo-800'}">${isUser ? 'You' : 'AI Assistant'}</p>
                            <p class="text-base leading-relaxed">${message.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        document.getElementById('chatbotForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!conversationStarted) {
                initializeChatbot();
                return;
            }
            
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat and history
            addChatbotMessage(message, true);
            conversationHistory.push({role: 'user', content: message});
            input.value = '';
            input.disabled = true;
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex justify-start';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="bg-gray-200 rounded-xl px-5 py-4 shadow-md">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <span class="text-sm text-gray-600 ml-2">AI is analyzing and thinking...</span>
                    </div>
                </div>
            `;
            document.getElementById('chatbotMessages').appendChild(typingDiv);
            document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
            
            try {
                const response = await fetch('/api/patient/chatbot', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: message,
                        patient_id: patientId,
                        conversation_history: conversationHistory  // Send full conversation history
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById('typingIndicator')?.remove();
                input.disabled = false;
                input.focus();
                
                if (data.success && data.response) {
                    // Add assistant response to chat and history
                    addChatbotMessage(data.response, false);
                    conversationHistory.push({role: 'assistant', content: data.response});
                    
                    // The response should contain a follow-up question, so the conversation continues
                } else {
                    const errorMsg = 'I apologize, but I encountered an error. Please try again.';
                    addChatbotMessage(errorMsg, false);
                    conversationHistory.push({role: 'assistant', content: errorMsg});
                }
            } catch (error) {
                document.getElementById('typingIndicator')?.remove();
                input.disabled = false;
                input.focus();
                console.error('Chatbot error:', error);
                const errorMsg = 'Error: ' + error.message + '. Please try again.';
                addChatbotMessage(errorMsg, false);
                conversationHistory.push({role: 'assistant', content: errorMsg});
            }
        });

        function showProfileModal() {
            window.location.href = '/patient/dashboard';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProfilePicture();
            initializeChatbot();
            // Focus on input after initialization
            setTimeout(() => {
                const input = document.getElementById('chatbotInput');
                if (input) {
                    input.focus();
                }
            }, 500);
        });
    </script>
</body>
</html>

