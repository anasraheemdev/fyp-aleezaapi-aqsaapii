<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ specialist_name }} - Doctor Portal | NeuraX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='neurax-theme.css') }}">
    <style>
        /* Animated Gradient Background */
        .hero-gradient {
            background: linear-gradient(-45deg, #0ea5e9, #6366f1, #8b5cf6, #06b6d4);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Sidebar with glassmorphism */
        .sidebar-modern {
            background: linear-gradient(180deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
        }

        .sidebar-item {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #06b6d4;
            transform: translateX(4px);
        }

        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(6, 182, 212, 0.3) 0%, transparent 100%);
            border-left-color: #67e8f9;
        }

        /* Icon backgrounds */
        .icon-gradient-1 {
            background: linear-gradient(135deg, #06b6d4, #0ea5e9);
        }

        /* Stat cards with glow */
        .stat-card {
            background: white;
            border-radius: 1rem;
            transition: all 0.4s ease;
            overflow: hidden;
            position: relative;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #06b6d4, #0ea5e9);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -12px rgba(6, 182, 212, 0.25);
        }

        .chat-message {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen">
    <!-- Modern Sidebar -->
    <div class="fixed inset-y-0 left-0 w-72 sidebar-modern text-white shadow-2xl z-50 flex flex-col">
        <!-- Logo Section -->
        <div class="p-6 border-b border-cyan-500/20">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 rounded-xl icon-gradient-1 flex items-center justify-center shadow-lg">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black">Neura<span class="text-cyan-400">X</span></h1>
                    <p class="text-xs text-cyan-300/80">Healthcare Intelligence</p>
                </div>
            </div>

            <!-- Doctor Profile Section -->
            {% if doctor and doctor.profile_picture %}
            <div class="flex flex-col items-center py-4">
                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 p-1 mb-4 shadow-xl">
                    <img src="{{ url_for('static', filename=doctor.profile_picture if doctor.profile_picture.startswith('profiles/') else 'profiles/' + doctor.profile_picture) }}"
                        alt="{{ doctor.name }}" class="w-full h-full rounded-full object-cover">
                </div>
                <h3 class="font-bold text-lg">{{ doctor.name }}</h3>
                <div class="flex items-center gap-2 mt-1">
                    <span class="px-2 py-0.5 bg-cyan-500/20 text-cyan-300 text-xs rounded-full capitalize">{{
                        specialists.get(doctor.specialist_type, 'Doctor') if doctor.specialist_type else 'Doctor'
                        }}</span>
                </div>
            </div>
            {% else %}
            <div class="flex flex-col items-center py-4">
                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 p-1 mb-4 shadow-xl">
                    <div class="w-full h-full rounded-full bg-slate-800 flex items-center justify-center">
                        <svg class="w-12 h-12 text-cyan-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
                <h3 class="font-bold text-lg">{{ user.full_name or 'Doctor' }}</h3>
                <p class="text-cyan-300 text-sm">Doctor Portal</p>
            </div>
            {% endif %}
        </div>

        <!-- Navigation - scrollable -->
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <a href="/doctor/dashboard"
                class="sidebar-item flex items-center px-4 py-3 rounded-xl text-cyan-200 hover:text-white">
                <div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                </div>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="/profile"
                class="sidebar-item flex items-center px-4 py-3 rounded-xl text-cyan-200 hover:text-white">
                <div class="w-10 h-10 rounded-lg bg-white/10 flex items-center justify-center mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <span class="font-medium">My Profile</span>
            </a>

            <div class="px-4 py-2 text-cyan-400/60 text-xs font-semibold uppercase mt-4 mb-2">Specialists</div>
            {% for key, name in specialists.items() %}
            <a href="/specialist/{{ key }}"
                class="sidebar-item {% if key == specialist_type %}active{% endif %} flex items-center px-4 py-3 rounded-xl {% if key == specialist_type %}text-white{% else %}text-cyan-200 hover:text-white{% endif %}">
                <div
                    class="w-10 h-10 rounded-lg {% if key == specialist_type %}icon-gradient-1 shadow{% else %}bg-white/10{% endif %} flex items-center justify-center mr-3">
                    <svg class="w-5 h-5 {% if key == specialist_type %}text-white{% endif %}" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                </div>
                <span class="{% if key == specialist_type %}font-semibold{% else %}font-medium{% endif %}">{{ name
                    }}</span>
            </a>
            {% endfor %}
        </nav>

        <!-- Logout - fixed at bottom -->
        <div class="p-4 border-t border-cyan-500/20">
            <a href="/logout"
                class="flex items-center px-4 py-3 rounded-xl text-rose-300 hover:bg-rose-500/20 transition-all">
                <div class="w-10 h-10 rounded-lg bg-rose-500/20 flex items-center justify-center mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                </div>
                <span class="font-medium">Sign Out</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-72">
        <!-- Header -->
        <div class="hero-gradient text-white py-6 px-8">
            <div class="flex items-center gap-3 mb-2">
                <span class="px-3 py-1 bg-white/20 backdrop-blur rounded-full text-sm font-medium">
                    ðŸ”¬ Specialist Portal
                </span>
            </div>
            <h1 class="text-3xl font-black">{{ specialist_name }}</h1>
            <p class="text-cyan-100">Upload test reports and get AI-powered insights</p>
        </div>

        <div class="p-8 max-w-7xl">
            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stat-card shadow-xl p-6">
                    <div class="flex items-center">
                        <div class="w-14 h-14 rounded-2xl icon-gradient-1 flex items-center justify-center shadow-lg">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-slate-500 text-sm font-medium">Total Reports</p>
                            <p class="text-3xl font-black text-slate-800" id="totalReports">0</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card shadow-xl p-6">
                    <div class="flex items-center">
                        <div
                            class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center shadow-lg">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                </path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-slate-500 text-sm font-medium">Analysis Accuracy</p>
                            <p class="text-3xl font-black text-slate-800">98.5%</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card shadow-xl p-6">
                    <div class="flex items-center">
                        <div
                            class="w-14 h-14 rounded-2xl bg-gradient-to-br from-violet-500 to-purple-500 flex items-center justify-center shadow-lg">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-slate-500 text-sm font-medium">Avg. Processing</p>
                            <p class="text-3xl font-black text-slate-800">12s</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Upload Section -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg icon-gradient-1 flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                    </path>
                                </svg>
                            </div>
                            Upload Report
                        </h2>
                        <form id="uploadForm" enctype="multipart/form-data" class="space-y-5">
                            <input type="hidden" name="specialist_type" value="{{ specialist_type }}">
                            <input type="hidden" id="doctorIdInput" name="doctor_id" value="">

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Patient Name *</label>
                                <input type="text" name="patient_name" required
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Report File *</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-cyan-500 transition-all cursor-pointer"
                                    onclick="document.getElementById('fileInput').click()">
                                    <input type="file" name="file" required accept=".png,.jpg,.jpeg,.pdf" id="fileInput"
                                        class="hidden">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                        viewBox="0 0 48 48">
                                        <path
                                            d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <p class="mt-3 text-sm text-gray-600 font-medium">Click to upload or drag and drop
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1">PNG, JPG, JPEG, PDF (MAX. 16MB)</p>
                                </div>
                                <p id="fileName" class="mt-2 text-sm text-cyan-600 font-medium hidden"></p>
                            </div>

                            <button type="submit" id="submitBtn"
                                class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-4 px-6 rounded-xl transition-all shadow-lg hover:shadow-xl">
                                <span id="submitText">Analyze Report</span>
                                <span id="submitLoading" class="hidden">Analyzing...</span>
                            </button>
                        </form>

                        <!-- Loading Indicator -->
                        <div id="loadingIndicator" class="hidden mt-6">
                            <div class="bg-cyan-50 border-2 border-cyan-200 rounded-xl p-6 text-center">
                                <div
                                    class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-cyan-200 border-t-cyan-600 mb-3">
                                </div>
                                <p class="text-cyan-700 font-semibold">Analyzing report with AI...</p>
                            </div>
                        </div>

                        <!-- Error Display -->
                        <div id="errorDisplay" class="hidden mt-6 bg-rose-50 border-2 border-rose-200 rounded-xl p-4">
                            <p id="errorMessage" class="text-rose-700 font-medium"></p>
                        </div>

                        <!-- Results Section -->
                        <div id="resultsSection" class="hidden mt-6 space-y-5">
                            <div class="bg-emerald-50 border-2 border-emerald-200 rounded-xl p-4">
                                <p class="text-emerald-700 font-bold flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Analysis Complete
                                </p>
                            </div>

                            <div>
                                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-lg bg-cyan-100 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                    </div>
                                    Extracted Text
                                </h3>
                                <div id="extractedText"
                                    class="bg-slate-50 border-2 border-slate-200 rounded-xl p-4 max-h-48 overflow-y-auto text-sm font-mono">
                                </div>
                            </div>

                            <div>
                                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-lg bg-violet-100 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-violet-600" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                                            </path>
                                        </svg>
                                    </div>
                                    AI Medical Analysis
                                </h3>
                                <div id="llmAnalysis"
                                    class="bg-gradient-to-br from-cyan-50 to-blue-50 border-2 border-cyan-200 rounded-xl p-6 text-sm max-w-none">
                                    <!-- Formatted content will be inserted here -->
                                </div>
                            </div>

                            <div id="bertSection" class="hidden">
                                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    Clinical BERT Analysis
                                </h3>
                                <div id="clinicalBertAnalysis"
                                    class="bg-emerald-50 border-2 border-emerald-200 rounded-xl p-4 text-sm"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Chart -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Report Activity</h3>
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Chatbot Section -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-lg bg-gradient-to-br from-violet-500 to-purple-500 flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                    </path>
                                </svg>
                            </div>
                            AI Assistant Chat (Clinical BERT)
                        </h2>
                        <div
                            class="bg-gradient-to-r from-violet-50 to-indigo-50 border-2 border-violet-200 rounded-xl p-4 mb-4">
                            <p class="text-sm text-violet-700 flex items-start">
                                <svg class="w-5 h-5 mr-2 text-violet-600 flex-shrink-0 mt-0.5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span><strong>Powered by Clinical BERT:</strong> This AI assistant uses Clinical BERT to
                                    understand medical terminology and provide context-aware responses for {{
                                    specialist_name }} professionals.</span>
                            </p>
                        </div>
                        <div id="chatContainer"
                            class="flex flex-col h-[500px] border-2 border-gray-200 rounded-xl overflow-hidden">
                            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-4">
                                <div
                                    class="chat-message bg-gradient-to-r from-violet-100 to-indigo-100 rounded-xl p-4 max-w-sm border border-violet-200">
                                    <p class="text-sm text-gray-700"><strong>Clinical BERT AI Assistant:</strong> Hello!
                                        I'm your {{ specialist_name }} AI assistant powered by Clinical BERT. I can help
                                        you with medical terminology, analysis, and professional guidance. How can I
                                        assist you today?</p>
                                </div>
                            </div>
                            <div class="border-t-2 border-gray-200 p-4 bg-white">
                                <div class="flex space-x-3">
                                    <input type="text" id="chatInput" placeholder="Type your message..."
                                        class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all"
                                        onkeypress="if(event.key==='Enter') document.getElementById('sendChatBtn').click()">
                                    <button id="sendChatBtn"
                                        class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white px-6 py-3 rounded-xl transition-all shadow-lg font-semibold">
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Statistics -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Chat Statistics</h3>
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="chatChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load doctor ID from localStorage
        const doctorId = localStorage.getItem('doctor_id') || '';
        document.getElementById('doctorIdInput').value = doctorId;

        let activityChart, chatChart;

        // File input display
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileName.textContent = `Selected: ${e.target.files[0].name}`;
                fileName.classList.remove('hidden');
            }
        });

        // Upload form
        const uploadForm = document.getElementById('uploadForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitLoading = document.getElementById('submitLoading');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');
        const bertSection = document.getElementById('bertSection');

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            resultsSection.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');

            const formData = new FormData(uploadForm);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('extractedText').textContent = data.extracted_text.substring(0, 500) + (data.extracted_text.length > 500 ? '...' : '');

                    // Display formatted HTML analysis
                    const analysisDiv = document.getElementById('llmAnalysis');

                    // Clear previous content
                    analysisDiv.innerHTML = '';

                    // Render HTML analysis - always use innerHTML since it's formatted HTML from server
                    if (data.llm_analysis) {
                        // Debug: Check what we received
                        console.log('Received llm_analysis, length:', data.llm_analysis.length);
                        console.log('First 200 chars:', data.llm_analysis.substring(0, 200));

                        // Server returns formatted HTML - render it directly using innerHTML
                        // This will parse and render the HTML tags
                        analysisDiv.innerHTML = data.llm_analysis;

                        // Verify it was rendered
                        console.log('After innerHTML, element has', analysisDiv.children.length, 'child elements');

                        // If it's still showing as text, try creating a temporary element
                        if (analysisDiv.textContent && analysisDiv.textContent.includes('<h3') && analysisDiv.children.length === 0) {
                            // HTML was escaped - try unescaping
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(data.llm_analysis, 'text/html');
                            analysisDiv.innerHTML = doc.body.innerHTML;
                        }
                    } else if (data.llm_analysis_raw) {
                        // Fallback - format raw text on client side
                        const formatted = formatAnalysisText(data.llm_analysis_raw);
                        analysisDiv.innerHTML = formatted;
                    } else {
                        analysisDiv.innerHTML = '<p class="text-gray-500">No analysis available</p>';
                    }

                    if (data.clinical_bert_analysis) {
                        document.getElementById('clinicalBertAnalysis').textContent = data.clinical_bert_analysis;
                        bertSection.classList.remove('hidden');
                    }

                    resultsSection.classList.remove('hidden');
                    loadActivityChart();
                    updateReportCount();
                } else {
                    errorMessage.textContent = data.error || 'An error occurred';
                    errorDisplay.classList.remove('hidden');
                }
            } catch (error) {
                errorMessage.textContent = error.message;
                errorDisplay.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        });

        // Chat functionality
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatMessages = document.getElementById('chatMessages');
        let chatCount = 0;

        function addChatMessage(message, isUser = true) {
            chatCount++;
            const div = document.createElement('div');
            div.className = `chat-message ${isUser ? 'bg-gradient-to-r from-cyan-500 to-blue-500 text-white rounded-xl p-4 ml-auto max-w-sm' : 'bg-slate-200 rounded-xl p-4 max-w-sm'}`;
            div.innerHTML = `<p class="text-sm">${message.replace(/\n/g, '<br>')}</p>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            updateChatChart();
        }

        sendChatBtn.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            if (!message) return;

            addChatMessage(message, true);
            chatInput.value = '';
            sendChatBtn.disabled = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        specialist_type: '{{ specialist_type }}',
                        doctor_id: doctorId || null
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    setTimeout(() => {
                        addChatMessage(data.response, false);
                    }, 500);
                } else {
                    addChatMessage('Error: ' + (data.error || 'Failed to get response'), false);
                }
            } catch (error) {
                addChatMessage('Error: ' + error.message, false);
            } finally {
                sendChatBtn.disabled = false;
            }
        });

        // Load specialist reports
        async function updateReportCount() {
            try {
                const response = await fetch('/api/reports/{{ specialist_type }}');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('totalReports').textContent = data.reports.length;
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        function loadActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            if (activityChart) activityChart.destroy();

            // Sample data - in production, fetch from API
            activityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Reports',
                        data: [2, 5, 3, 7, 4, 6, 3],
                        backgroundColor: 'rgba(6, 182, 212, 0.8)',
                        borderColor: 'rgba(6, 182, 212, 1)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.8,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateChatChart() {
            const ctx = document.getElementById('chatChart').getContext('2d');
            if (chatChart) chatChart.destroy();

            chatChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['User Messages', 'AI Responses'],
                    datasets: [{
                        data: [chatCount, chatCount],
                        backgroundColor: [
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Format analysis text function
        function formatAnalysisText(text) {
            if (!text) return '';

            // Escape HTML first, then process markdown
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function processBold(text) {
                return text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-gray-900">$1</strong>');
            }

            let html = '';
            const lines = text.split('\n');
            let inList = false;
            let inTable = false;
            let tableRows = [];

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    if (inTable && tableRows.length > 0) {
                        html += formatTable(tableRows);
                        tableRows = [];
                        inTable = false;
                    }
                    html += '<br>';
                    continue;
                }

                // Check for table rows
                if (line.includes('|') && (line.match(/\|/g) || []).length >= 2) {
                    const cells = line.split('|').map(c => c.trim()).filter(c => c);
                    const isSeparator = cells.every(c => c.replace(/-/g, '').trim() === '');
                    if (!isSeparator && cells.length > 0) {
                        tableRows.push(cells);
                        inTable = true;
                        if (inList) {
                            html += '</ul>';
                            inList = false;
                        }
                    }
                    continue;
                }

                if (inTable && tableRows.length > 0) {
                    html += formatTable(tableRows);
                    tableRows = [];
                    inTable = false;
                }

                // Main headings with ##
                if (line.startsWith('##')) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    const headingText = processBold(escapeHtml(line.replace(/^##\s*/, '')));
                    html += `<h3 class="text-xl font-bold text-gray-800 mt-4 mb-2 pb-2 border-b-2 border-cyan-300">${headingText}</h3>`;
                }
                // Numbered headings
                else if (/^\d+\.\s+[A-Z]/.test(line)) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    const headingText = processBold(escapeHtml(line.replace(/^\d+\.\s+/, '')));
                    html += `<h3 class="text-lg font-bold text-gray-800 mt-4 mb-2 pb-2 border-b border-cyan-200">${headingText}</h3>`;
                }
                // Subheadings
                else if ((line.endsWith(':') && line.length < 60) || (line === line.toUpperCase() && line.length > 5 && line.length < 50)) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    const headingText = processBold(escapeHtml(line));
                    html += `<h4 class="text-lg font-semibold text-gray-700 mt-3 mb-2">${headingText}</h4>`;
                }
                // Bullet points
                else if (/^[-*â€¢]\s/.test(line) || /^\d+[.)]\s/.test(line)) {
                    if (!inList) {
                        html += '<ul class="list-disc list-inside space-y-1 ml-4 mb-3">';
                        inList = true;
                    }
                    const bulletText = processBold(escapeHtml(line.replace(/^[-*â€¢\d.)\s]+/, '')));
                    html += `<li class="text-gray-700 mb-1">${bulletText}</li>`;
                }
                // Regular paragraph
                else {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    const processedLine = processBold(escapeHtml(line));
                    html += `<p class="text-gray-700 mb-2 leading-relaxed">${processedLine}</p>`;
                }
            }

            if (inList) html += '</ul>';
            if (inTable && tableRows.length > 0) html += formatTable(tableRows);
            return html;
        }

        function formatTable(rows) {
            if (!rows || rows.length === 0) return '';

            let html = '<div class="overflow-x-auto my-4"><table class="min-w-full border-collapse border border-gray-300">';

            if (rows.length > 0) {
                html += '<thead class="bg-cyan-100"><tr>';
                rows[0].forEach(cell => {
                    html += `<th class="border border-gray-300 px-4 py-2 text-left font-semibold text-gray-800">${cell}</th>`;
                });
                html += '</tr></thead><tbody>';

                for (let i = 1; i < rows.length; i++) {
                    html += '<tr class="hover:bg-gray-50">';
                    rows[i].forEach(cell => {
                        html += `<td class="border border-gray-300 px-4 py-2 text-gray-700">${cell}</td>`;
                    });
                    html += '</tr>';
                }
                html += '</tbody>';
            }

            html += '</table></div>';
            return html;
        }

        // Initialize
        updateReportCount();
        loadActivityChart();
        updateChatChart();
    </script>
</body>

</html>